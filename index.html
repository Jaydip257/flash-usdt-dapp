<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flash USDT DApp</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo-section h1 {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: white;
    }
    
    .mode-toggle label {
      font-size: 0.9rem;
    }
    
    .mode-toggle input[type="checkbox"] {
      transform: scale(1.2);
    }
    
    main {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .wallet-info {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }
    
    #account {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    #balance {
      font-size: 2rem;
      font-weight: bold;
      color: #28a745;
      margin-bottom: 0.5rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #007bff;
    }
    
    .form-section h3 {
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.2rem;
    }
    
    .form-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    input {
      flex: 1;
      padding: 0.8rem;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      min-width: 200px;
    }
    
    input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    button {
      padding: 0.8rem 1.5rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }
    
    button:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #connect-btn {
      background: #28a745;
    }
    
    #connect-btn:hover {
      background: #1e7e34;
    }
    
    #add-token-btn {
      background: #17a2b8;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    #add-token-btn:hover {
      background: #117a8b;
    }
    
    #mint-btn {
      background: #ffc107;
      color: #333;
    }
    
    #mint-btn:hover {
      background: #e0a800;
    }
    
    #trans-btn {
      background: #28a745;
    }
    
    #trans-btn:hover {
      background: #1e7e34;
    }
    
    #exp-btn {
      background: #dc3545;
    }
    
    #exp-btn:hover {
      background: #bd2130;
    }
    
    .quick-fill {
      background: #6c757d;
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      margin-left: 0.5rem;
    }
    
    .quick-fill:hover {
      background: #5a6268;
    }
    
    #status {
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .testing-mode {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 600;
    }
    
    .trusted-wallets {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #e7f3ff;
      border-radius: 8px;
      border-left: 4px solid #0056b3;
    }
    
    .trusted-wallets h4 {
      margin-bottom: 0.5rem;
      color: #0056b3;
    }
    
    .trusted-wallets .wallet-list {
      font-family: monospace;
      font-size: 0.85rem;
      color: #666;
      max-height: 100px;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      
      main {
        margin: 1rem;
        padding: 1rem;
      }
      
      .form-group {
        flex-direction: column;
      }
      
      input, button {
        width: 100%;
      }
      
      #balance {
        font-size: 1.5rem;
      }
      
      .quick-fill {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-section">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="48" height="48" rx="12" fill="#26A17B"/>
        <path d="M24 8C31.732 8 38 14.268 38 22C38 29.732 31.732 36 24 36C16.268 36 10 29.732 10 22C10 14.268 16.268 8 24 8ZM24 11C17.925 11 13 15.925 13 22C13 28.075 17.925 33 24 33C30.075 33 35 28.075 35 22C35 15.925 30.075 11 24 11ZM24 14C28.418 14 32 17.582 32 22C32 26.418 28.418 30 24 30C19.582 30 16 26.418 16 22C16 17.582 19.582 14 24 14Z" fill="white"/>
        <text x="24" y="28" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="8" font-weight="bold">USDT</text>
      </svg>
      <h1>Flash USDT DApp</h1>
    </div>
    <div style="display: flex; align-items: center; gap: 2rem;">
      <div class="mode-toggle">
        <label for="testing-mode">Testing Mode:</label>
        <input type="checkbox" id="testing-mode" checked>
      </div>
      <button id="connect-btn">Connect Wallet</button>
    </div>
  </header>
  
  <main>
    <div class="testing-mode" id="testing-indicator">
      üß™ TESTING MODE ACTIVE - Self transfers allowed for testing
    </div>
    
    <div class="wallet-info">
      <div id="account">Not connected</div>
      <div id="balance">0 USDT</div>
    </div>
    
    <!-- Trusted Wallets Display (only shown in production mode) -->
    <div class="trusted-wallets" id="trusted-wallets-info" style="display: none;">
      <h4>üîí Trusted Wallets Only</h4>
      <div class="wallet-list">
        Production mode: Only pre-approved wallets can connect
      </div>
    </div>
    
    <div class="form-section">
      <h3>ü™ô Add Token to Wallet</h3>
      <button id="add-token-btn">Add USDT to MetaMask</button>
    </div>
    
    <div class="form-section">
      <h3>‚ö° Mint Tokens</h3>
      <div class="form-group">
        <input id="mint-to" placeholder="Recipient address (0x...)" />
        <input id="mint-amt" placeholder="Amount (e.g., 1000)" type="number" />
        <button id="mint-btn">Mint</button>
        <button class="quick-fill" onclick="fillCurrentAddress('mint')">Use My Address</button>
      </div>
    </div>
    
    <div class="form-section">
      <h3>üí∏ Transfer Tokens</h3>
      <div class="form-group">
        <input id="trans-to" placeholder="Recipient address (0x...)" />
        <input id="trans-amt" placeholder="Amount (e.g., 100)" type="number" />
        <button id="trans-btn">Transfer</button>
        <button class="quick-fill" onclick="fillCurrentAddress('transfer')">Use My Address</button>
      </div>
    </div>
    
    <div class="form-section">
      <h3>‚è∞ Set Token Expiry</h3>
      <div class="form-group">
        <input id="exp-to" placeholder="Address (0x...)" />
        <input id="exp-days" placeholder="Days (e.g., 30)" type="number" min="1" max="365" />
        <button id="exp-btn">Set Expiry</button>
        <button class="quick-fill" onclick="fillCurrentAddress('expiry')">Use My Address</button>
      </div>
    </div>
    
    <div id="status">Ready to use - Connect your wallet to start</div>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0xC47711d8b4Cba5D9Ccc4e498A204EA53c31779aD";
    let provider, signer, contract;
    let currentUserAddress = null;
    
    // Trusted wallets for production mode (add your trusted addresses here)
    const TRUSTED_WALLETS = [
      "0xYourTrustedWallet1...", // Replace with actual trusted wallets
      "0xYourTrustedWallet2...", // Replace with actual trusted wallets
      "0xYourTrustedWallet3...", // Replace with actual trusted wallets
      // Add more trusted wallet addresses here when going live
    ];

    // Check if testing mode is enabled
    function isTestingMode() {
      return document.getElementById('testing-mode').checked;
    }

    // Check if wallet is trusted (for production mode)
    function isTrustedWallet(address) {
      return TRUSTED_WALLETS.includes(address.toLowerCase()) || 
             TRUSTED_WALLETS.includes(address);
    }

    // Fill current user address in forms
    function fillCurrentAddress(formType) {
      if (!currentUserAddress) {
        alert("‚ùå Please connect your wallet first!");
        return;
      }
      
      switch(formType) {
        case 'mint':
          document.getElementById('mint-to').value = currentUserAddress;
          break;
        case 'transfer':
          document.getElementById('trans-to').value = currentUserAddress;
          break;
        case 'expiry':
          document.getElementById('exp-to').value = currentUserAddress;
          break;
      }
    }

    // Update UI based on testing mode
    function updateModeUI() {
      const testingIndicator = document.getElementById('testing-indicator');
      const trustedWalletsInfo = document.getElementById('trusted-wallets-info');
      
      if (isTestingMode()) {
        testingIndicator.style.display = 'block';
        trustedWalletsInfo.style.display = 'none';
        testingIndicator.innerHTML = 'üß™ TESTING MODE ACTIVE - Self transfers allowed for testing';
      } else {
        testingIndicator.style.display = 'none';
        trustedWalletsInfo.style.display = 'block';
        testingIndicator.innerHTML = 'üîí PRODUCTION MODE - Only trusted wallets allowed';
      }
    }

    // Wait for DOM to be fully loaded
    document.addEventListener("DOMContentLoaded", function() {
      console.log("üöÄ Flash USDT DApp loaded successfully");
      
      // Attach event listeners
      document.getElementById("connect-btn").addEventListener("click", connect);
      document.getElementById("add-token-btn").addEventListener("click", addToken);
      document.getElementById("mint-btn").addEventListener("click", mint);
      document.getElementById("trans-btn").addEventListener("click", transfer);
      document.getElementById("exp-btn").addEventListener("click", setExpiry);
      document.getElementById("testing-mode").addEventListener("change", updateModeUI);
      
      // Initialize UI
      updateModeUI();
      
      console.log("‚úÖ Event listeners attached");
    });

    async function connect() {
      try {
        console.log("üöÄ Connecting wallet...");
        updateStatus("üöÄ Connecting wallet...", "info");
        
        if (!window.ethereum) {
          alert("‚ùå MetaMask not found! Please install MetaMask.");
          return;
        }
        
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        
        const acc = await signer.getAddress();
        currentUserAddress = acc;
        
        // Check if wallet is trusted (only in production mode)
        if (!isTestingMode() && !isTrustedWallet(acc)) {
          alert(`‚ùå Wallet not authorized!

Your wallet: ${acc}

This DApp is in production mode and only allows connections from pre-approved trusted wallets.

Please contact the administrator to add your wallet to the trusted list.`);
          
          updateStatus("‚ùå Wallet not authorized - Contact admin", "error");
          return;
        }
        
        document.getElementById("account").innerText = `${acc.slice(0,6)}...${acc.slice(-4)}`;
        
        // Set default balance
        const balance = localStorage.getItem(`balance_${acc}`) || "1000000";
        document.getElementById("balance").innerText = `${parseFloat(balance).toLocaleString()} USDT`;
        
        const mode = isTestingMode() ? "Testing" : "Production";
        updateStatus(`‚úÖ Wallet connected successfully! (${mode} Mode)`, "success");
        
        console.log("‚úÖ Wallet connected:", acc);
        
      } catch (err) {
        console.error("Connection Error:", err);
        updateStatus("‚ùå Connection failed: " + err.message, "error");
      }
    }

    async function addToken() {
      try {
        console.log("ü™ô Adding token to MetaMask...");
        updateStatus("ü™ô Adding token to MetaMask...", "info");
        
        if (!window.ethereum) {
          alert("‚ùå MetaMask not found!");
          return;
        }

        const logoUrl = "https://cryptologos.cc/logos/tether-usdt-logo.png";
        
        const added = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: CONTRACT_ADDRESS,
              symbol: "USDT",
              decimals: 6,
              image: logoUrl,
            },
          },
        });
        
        if (added) {
          console.log('‚úÖ USDT token added to MetaMask');
          updateStatus("‚úÖ USDT token added to MetaMask!", "success");
          alert('‚úÖ USDT Token successfully added to MetaMask!\n\nYou can now see USDT in your token list.');
        } else {
          updateStatus("‚ùå Token addition cancelled", "error");
        }
        
      } catch (err) {
        console.error("Add Token Error:", err);
        alert('‚ùå Error adding token: ' + err.message);
        updateStatus("‚ùå Error adding token", "error");
      }
    }

    async function mint() {
      try {
        const to = document.getElementById("mint-to").value.trim();
        const amt = document.getElementById("mint-amt").value.trim();
        
        if (!to || !amt) {
          alert("‚ùå Please fill in both address and amount");
          return;
        }
        
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid address format");
          return;
        }
        
        const amount = parseFloat(amt);
        if (isNaN(amount) || amount <= 0) {
          alert("‚ùå Invalid amount");
          return;
        }
        
        console.log("üöÄ Starting mint process...");
        updateStatus("üöÄ Minting tokens...", "info");
        
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        const currentBalance = parseFloat(localStorage.getItem(`balance_${to}`) || '0');
        const newBalance = currentBalance + amount;
        localStorage.setItem(`balance_${to}`, newBalance.toString());
        
        const transaction = {
          hash: txHash,
          from: await signer.getAddress(),
          to: to,
          amount: amount,
          type: "mint",
          timestamp: Date.now(),
          status: "confirmed",
          testingMode: isTestingMode()
        };
        
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        transactions.unshift(transaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        updateStatus("‚úÖ Mint completed successfully!", "success");
        
        document.getElementById("mint-to").value = "";
        document.getElementById("mint-amt").value = "";
        
        // Update balance if minting to current user
        if (to.toLowerCase() === currentUserAddress?.toLowerCase()) {
          document.getElementById("balance").innerText = `${newBalance.toLocaleString()} USDT`;
        }
        
        setTimeout(() => {
          alert(`üéâ Mint Successful!

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç To: ${to}
üîó Transaction Hash: ${txHash}
‚è∞ Time: ${new Date().toLocaleString()}
üß™ Mode: ${isTestingMode() ? 'Testing' : 'Production'}

‚úÖ Tokens have been minted successfully!
‚úÖ Recipient balance updated to ${newBalance.toLocaleString()} USDT`);
        }, 1000);
        
      } catch (err) {
        console.error("Mint error:", err);
        updateStatus("‚ùå Mint failed: " + err.message, "error");
      }
    }

    async function transfer() {
      try {
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        const to = document.getElementById("trans-to").value.trim();
        const amt = document.getElementById("trans-amt").value.trim();
        
        if (!to || !amt) {
          alert("‚ùå Please fill in both address and amount");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid recipient address");
          return;
        }
        
        const amount = parseFloat(amt);
        if (isNaN(amount) || amount <= 0) {
          alert("‚ùå Invalid amount");
          return;
        }
        
        const currentUser = await signer.getAddress();
        
        // Check self-transfer based on mode
        if (currentUser.toLowerCase() === to.toLowerCase()) {
          if (!isTestingMode()) {
            alert("‚ùå Cannot send tokens to yourself in production mode");
            return;
          } else {
            console.log("‚úÖ Self-transfer allowed in testing mode");
          }
        }
        
        const senderBalance = parseFloat(localStorage.getItem(`balance_${currentUser}`) || '1000000');
        if (senderBalance < amount) {
          alert(`‚ùå Insufficient balance!

Your balance: ${senderBalance.toLocaleString()} USDT
Trying to send: ${amount.toLocaleString()} USDT

Please enter a smaller amount.`);
          return;
        }
        
        const isSelfTransfer = currentUser.toLowerCase() === to.toLowerCase();
        const transferType = isSelfTransfer ? "Self-Transfer (Testing)" : "Transfer";
        
        const confirmTransfer = confirm(`üîÑ Confirm ${transferType}

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç From: ${currentUser.slice(0,8)}...${currentUser.slice(-6)}
üìç To: ${to.slice(0,8)}...${to.slice(-6)}
${isSelfTransfer ? 'üß™ Testing Mode: Self-transfer' : 'üíµ Your balance after transfer: ' + (senderBalance - amount).toLocaleString() + ' USDT'}
üß™ Mode: ${isTestingMode() ? 'Testing' : 'Production'}

‚ö†Ô∏è This action cannot be undone.
Click OK to proceed with ${transferType.toLowerCase()}.`);
        
        if (!confirmTransfer) {
          updateStatus("‚ùå Transfer cancelled by user", "error");
          return;
        }
        
        console.log("üöÄ Processing transfer...");
        updateStatus("üöÄ Processing transfer...", "info");
        
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        const newSenderBalance = senderBalance - amount;
        const recipientBalance = parseFloat(localStorage.getItem(`balance_${to}`) || '0');
        const newRecipientBalance = recipientBalance + amount;
        
        localStorage.setItem(`balance_${currentUser}`, newSenderBalance.toString());
        localStorage.setItem(`balance_${to}`, newRecipientBalance.toString());
        
        const transaction = {
          hash: txHash,
          from: currentUser,
          to: to,
          amount: amount,
          type: isSelfTransfer ? "self_transfer" : "transfer",
          timestamp: Date.now(),
          status: "confirmed",
          blockNumber: Math.floor(Math.random() * 1000000) + 18000000,
          testingMode: isTestingMode()
        };
        
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        transactions.unshift(transaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        document.getElementById("balance").innerText = `${newSenderBalance.toLocaleString()} USDT`;
        updateStatus("‚úÖ Transfer completed successfully!", "success");
        
        document.getElementById("trans-to").value = "";
        document.getElementById("trans-amt").value = "";
        
        setTimeout(() => {
          alert(`üéâ ${transferType} Successful!

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç From: ${currentUser.slice(0,8)}...${currentUser.slice(-6)}
üìç To: ${to.slice(0,8)}...${to.slice(-6)}
üîó Transaction Hash: ${txHash}
üè¶ Block Number: ${transaction.blockNumber}
‚è∞ Time: ${new Date().toLocaleString()}
üß™ Mode: ${isTestingMode() ? 'Testing' : 'Production'}

‚úÖ Transfer completed successfully!
‚úÖ Your new balance: ${newSenderBalance.toLocaleString()} USDT
‚úÖ Recipient received: ${amount.toLocaleString()} USDT
${isSelfTransfer ? 'üß™ Self-transfer completed for testing purposes' : ''}

üîç This transaction will appear in MetaMask transaction history.`);
        }, 1500);
        
      } catch (err) {
        console.error("Transfer error:", err);
        updateStatus("‚ùå Transfer failed: " + err.message, "error");
      }
    }

    async function setExpiry() {
      try {
        const to = document.getElementById("exp-to").value.trim();
        const days = parseInt(document.getElementById("exp-days").value);
        
        if (!to || !days) {
          alert("‚ùå Please fill in both address and number of days");
          return;
        }
        
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid address format");
          return;
        }
        
        if (days <= 0 || days > 365) {
          alert("‚ùå Days must be between 1 and 365");
          return;
        }
        
        console.log("üöÄ Setting expiry...");
        updateStatus("üöÄ Setting token expiry...", "info");
        
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + days);
        
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        const expiries = JSON.parse(localStorage.getItem('token_expiries') || '{}');
        expiries[to] = {
          expiryDate: expiryDate.getTime(),
          daysFromNow: days,
          setBy: await signer.getAddress(),
          txHash: txHash,
          timestamp: Date.now(),
          testingMode: isTestingMode()
        };
        localStorage.setItem('token_expiries', JSON.stringify(expiries));
        
        updateStatus("‚úÖ Expiry set successfully!", "success");
        
        document.getElementById("exp-to").value = "";
        document.getElementById("exp-days").value = "";
        
        setTimeout(() => {
          alert(`‚úÖ Token Expiry Set Successfully!

üìç Address: ${to}
üìÖ Days: ${days}
üóìÔ∏è Expiry Date: ${expiryDate.toLocaleDateString()} ${expiryDate.toLocaleTimeString()}
üîó Transaction Hash: ${txHash}
‚è∞ Set Time: ${new Date().toLocaleString()}
üß™ Mode: ${isTestingMode() ? 'Testing' : 'Production'}

‚úÖ Token expiry has been set successfully!`);
        }, 1000);
        
      } catch (err) {
        console.error("Set Expiry Error:", err);
        updateStatus("‚ùå Expiry setting failed: " + err.message, "error");
      }
    }

    function updateStatus(message, type = "info") {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message;
      statusEl.className = type;
    }

    if (window.ethereum) {
      window.ethereum.on('accountsChanged', async (accounts) => {
        if (accounts.length > 0 && signer) {
          const currentUser = accounts[0];
          currentUserAddress = currentUser;
          
          // Check trusted wallet in production mode
          if (!isTestingMode() && !isTrustedWallet(currentUser)) {
            alert(`‚ùå New wallet not authorized!

Your new wallet: ${currentUser}

This DApp is in production mode. Please switch back to an authorized wallet or enable testing mode.`);
            
            updateStatus("‚ùå Unauthorized wallet detected", "error");
            document.getElementById("account").innerText = "Unauthorized";
            document.getElementById("balance").innerText = "0 USDT";
            return;
          }
          
          const balance = parseFloat(localStorage.getItem(`balance_${currentUser}`) || '1000000');
          document.getElementById("balance").innerText = `${balance.toLocaleString()} USDT`;
          document.getElementById("account").innerText = `${currentUser.slice(0,6)}...${currentUser.slice(-4)}`;
          console.log("Account changed, balance updated");
        }
      });
    }
  </script>
</body>
</html>

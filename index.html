<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flash USDT DApp</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo-section h1 {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    main {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .wallet-info {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }
    
    #account {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    
    #balance {
      font-size: 2rem;
      font-weight: bold;
      color: #28a745;
      margin-bottom: 0.5rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #007bff;
    }
    
    .form-section h3 {
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.2rem;
    }
    
    .form-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    input {
      flex: 1;
      padding: 0.8rem;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      min-width: 200px;
    }
    
    input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    button {
      padding: 0.8rem 1.5rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }
    
    button:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    #connect-btn {
      background: #28a745;
    }
    
    #connect-btn:hover {
      background: #1e7e34;
    }
    
    #add-token-btn {
      background: #17a2b8;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    #add-token-btn:hover {
      background: #117a8b;
    }
    
    #mint-btn {
      background: #ffc107;
      color: #333;
    }
    
    #mint-btn:hover {
      background: #e0a800;
    }
    
    #trans-btn {
      background: #28a745;
    }
    
    #trans-btn:hover {
      background: #1e7e34;
    }
    
    #exp-btn {
      background: #dc3545;
    }
    
    #exp-btn:hover {
      background: #bd2130;
    }
    
    #status {
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 768px) {
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      
      main {
        margin: 1rem;
        padding: 1rem;
      }
      
      .form-group {
        flex-direction: column;
      }
      
      input, button {
        width: 100%;
      }
      
      #balance {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-section">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="48" height="48" rx="12" fill="#26A17B"/>
        <path d="M24 8C31.732 8 38 14.268 38 22C38 29.732 31.732 36 24 36C16.268 36 10 29.732 10 22C10 14.268 16.268 8 24 8ZM24 11C17.925 11 13 15.925 13 22C13 28.075 17.925 33 24 33C30.075 33 35 28.075 35 22C35 15.925 30.075 11 24 11ZM24 14C28.418 14 32 17.582 32 22C32 26.418 28.418 30 24 30C19.582 30 16 26.418 16 22C16 17.582 19.582 14 24 14Z" fill="white"/>
        <text x="24" y="28" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="8" font-weight="bold">USDT</text>
      </svg>
      <h1>Flash USDT DApp</h1>
    </div>
    <button id="connect-btn">Connect Wallet</button>
  </header>
  
  <main>
    <div class="wallet-info">
      <div id="account">Not connected</div>
      <div id="balance">0 USDT</div>
    </div>
    
    <div class="form-section">
      <h3>ü™ô Add Token to Wallet</h3>
      <button id="add-token-btn">Add USDT to MetaMask</button>
    </div>
    
    <div class="form-section">
      <h3>‚ö° Mint Tokens</h3>
      <div class="form-group">
        <input id="mint-to" placeholder="Recipient address (0x...)" />
        <input id="mint-amt" placeholder="Amount (e.g., 1000)" type="number" />
        <button id="mint-btn">Mint</button>
      </div>
    </div>
    
    <div class="form-section">
      <h3>üí∏ Transfer Tokens</h3>
      <div class="form-group">
        <input id="trans-to" placeholder="Recipient address (0x...)" />
        <input id="trans-amt" placeholder="Amount (e.g., 100)" type="number" />
        <button id="trans-btn">Transfer</button>
      </div>
    </div>
    
    <div class="form-section">
      <h3>‚è∞ Set Token Expiry</h3>
      <div class="form-group">
        <input id="exp-to" placeholder="Address (0x...)" />
        <input id="exp-days" placeholder="Days (e.g., 30)" type="number" min="1" max="365" />
        <button id="exp-btn">Set Expiry</button>
      </div>
    </div>
    
    <div id="status">Ready to use - Connect your wallet to start</div>
  </main>
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0xC47711d8b4Cba5D9Ccc4e498A204EA53c31779aD";
    let provider, signer, contract;

    // Wait for DOM to be fully loaded
    document.addEventListener("DOMContentLoaded", function() {
      console.log("üöÄ Flash USDT DApp loaded successfully");
      
      // Attach event listeners
      document.getElementById("connect-btn").addEventListener("click", connect);
      document.getElementById("add-token-btn").addEventListener("click", addToken);
      document.getElementById("mint-btn").addEventListener("click", mint);
      document.getElementById("trans-btn").addEventListener("click", transfer);
      document.getElementById("exp-btn").addEventListener("click", setExpiry);
      
      console.log("‚úÖ Event listeners attached");
    });

    async function connect() {
      try {
        console.log("üöÄ Connecting wallet...");
        updateStatus("üöÄ Connecting wallet...", "info");
        
        if (!window.ethereum) {
          alert("‚ùå MetaMask not found! Please install MetaMask.");
          return;
        }
        
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        
        const acc = await signer.getAddress();
        document.getElementById("account").innerText = `${acc.slice(0,6)}...${acc.slice(-4)}`;
        
        // Set default balance
        const balance = localStorage.getItem(`balance_${acc}`) || "1000000";
        document.getElementById("balance").innerText = `${parseFloat(balance).toLocaleString()} USDT`;
        updateStatus("‚úÖ Wallet connected successfully!", "success");
        
        console.log("‚úÖ Wallet connected:", acc);
        
      } catch (err) {
        console.error("Connection Error:", err);
        updateStatus("‚ùå Connection failed: " + err.message, "error");
      }
    }

    async function addToken() {
      try {
        console.log("ü™ô Adding token to MetaMask...");
        updateStatus("ü™ô Adding token to MetaMask...", "info");
        
        if (!window.ethereum) {
          alert("‚ùå MetaMask not found!");
          return;
        }

        // Use a generic logo URL that works
        const logoUrl = "https://cryptologos.cc/logos/tether-usdt-logo.png";
        
        const added = await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: CONTRACT_ADDRESS,
              symbol: "USDT",
              decimals: 6,
              image: logoUrl,
            },
          },
        });
        
        if (added) {
          console.log('‚úÖ USDT token added to MetaMask');
          updateStatus("‚úÖ USDT token added to MetaMask!", "success");
          alert('‚úÖ USDT Token successfully added to MetaMask!\n\nYou can now see USDT in your token list.');
        } else {
          updateStatus("‚ùå Token addition cancelled", "error");
        }
        
      } catch (err) {
        console.error("Add Token Error:", err);
        alert('‚ùå Error adding token: ' + err.message);
        updateStatus("‚ùå Error adding token", "error");
      }
    }

    async function mint() {
      try {
        const to = document.getElementById("mint-to").value.trim();
        const amt = document.getElementById("mint-amt").value.trim();
        
        // Validation
        if (!to || !amt) {
          alert("‚ùå Please fill in both address and amount");
          return;
        }
        
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid address format");
          return;
        }
        
        const amount = parseFloat(amt);
        if (isNaN(amount) || amount <= 0) {
          alert("‚ùå Invalid amount");
          return;
        }
        
        console.log("üöÄ Starting mint process...");
        updateStatus("üöÄ Minting tokens...", "info");
        
        // Generate transaction hash
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        // Update recipient balance
        const currentBalance = parseFloat(localStorage.getItem(`balance_${to}`) || '0');
        const newBalance = currentBalance + amount;
        localStorage.setItem(`balance_${to}`, newBalance.toString());
        
        // Store transaction
        const transaction = {
          hash: txHash,
          from: await signer.getAddress(),
          to: to,
          amount: amount,
          type: "mint",
          timestamp: Date.now(),
          status: "confirmed"
        };
        
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        transactions.unshift(transaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        updateStatus("‚úÖ Mint completed successfully!", "success");
        
        // Clear form
        document.getElementById("mint-to").value = "";
        document.getElementById("mint-amt").value = "";
        
        // Show success message
        setTimeout(() => {
          alert(`üéâ Mint Successful!

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç To: ${to}
üîó Transaction Hash: ${txHash}
‚è∞ Time: ${new Date().toLocaleString()}

‚úÖ Tokens have been minted successfully!
‚úÖ Recipient balance updated to ${newBalance.toLocaleString()} USDT`);
        }, 1000);
        
      } catch (err) {
        console.error("Mint error:", err);
        updateStatus("‚ùå Mint failed: " + err.message, "error");
      }
    }

    async function transfer() {
      try {
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        const to = document.getElementById("trans-to").value.trim();
        const amt = document.getElementById("trans-amt").value.trim();
        
        // Validation
        if (!to || !amt) {
          alert("‚ùå Please fill in both address and amount");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid recipient address");
          return;
        }
        
        const amount = parseFloat(amt);
        if (isNaN(amount) || amount <= 0) {
          alert("‚ùå Invalid amount");
          return;
        }
        
        const currentUser = await signer.getAddress();
        
        // Check if sending to self
        if (currentUser.toLowerCase() === to.toLowerCase()) {
          alert("‚ùå Cannot send tokens to yourself");
          return;
        }
        
        // Check balance
        const senderBalance = parseFloat(localStorage.getItem(`balance_${currentUser}`) || '1000000');
        if (senderBalance < amount) {
          alert(`‚ùå Insufficient balance!

Your balance: ${senderBalance.toLocaleString()} USDT
Trying to send: ${amount.toLocaleString()} USDT

Please enter a smaller amount.`);
          return;
        }
        
        // Show confirmation popup
        const confirmTransfer = confirm(`üîÑ Confirm Transfer

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç From: ${currentUser.slice(0,8)}...${currentUser.slice(-6)}
üìç To: ${to.slice(0,8)}...${to.slice(-6)}
üíµ Your balance after transfer: ${(senderBalance - amount).toLocaleString()} USDT

‚ö†Ô∏è This action cannot be undone.
Click OK to proceed with transfer.`);
        
        if (!confirmTransfer) {
          updateStatus("‚ùå Transfer cancelled by user", "error");
          return;
        }
        
        console.log("üöÄ Processing transfer...");
        updateStatus("üöÄ Processing transfer...", "info");
        
        // Generate transaction hash
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        // Update balances
        const newSenderBalance = senderBalance - amount;
        const recipientBalance = parseFloat(localStorage.getItem(`balance_${to}`) || '0');
        const newRecipientBalance = recipientBalance + amount;
        
        localStorage.setItem(`balance_${currentUser}`, newSenderBalance.toString());
        localStorage.setItem(`balance_${to}`, newRecipientBalance.toString());
        
        // Create transaction record
        const transaction = {
          hash: txHash,
          from: currentUser,
          to: to,
          amount: amount,
          type: "transfer",
          timestamp: Date.now(),
          status: "confirmed",
          blockNumber: Math.floor(Math.random() * 1000000) + 18000000
        };
        
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        transactions.unshift(transaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        // Update UI
        document.getElementById("balance").innerText = `${newSenderBalance.toLocaleString()} USDT`;
        updateStatus("‚úÖ Transfer completed successfully!", "success");
        
        // Clear form
        document.getElementById("trans-to").value = "";
        document.getElementById("trans-amt").value = "";
        
        // Show success message
        setTimeout(() => {
          alert(`üéâ Transfer Successful!

üí∞ Amount: ${amount.toLocaleString()} USDT
üìç From: ${currentUser.slice(0,8)}...${currentUser.slice(-6)}
üìç To: ${to.slice(0,8)}...${to.slice(-6)}
üîó Transaction Hash: ${txHash}
üè¶ Block Number: ${transaction.blockNumber}
‚è∞ Time: ${new Date().toLocaleString()}

‚úÖ Transfer completed successfully!
‚úÖ Your new balance: ${newSenderBalance.toLocaleString()} USDT
‚úÖ Recipient received: ${amount.toLocaleString()} USDT
‚úÖ Transaction recorded in blockchain

üîç This transaction will appear in MetaMask transaction history.`);
        }, 1500);
        
      } catch (err) {
        console.error("Transfer error:", err);
        updateStatus("‚ùå Transfer failed: " + err.message, "error");
      }
    }

    async function setExpiry() {
      try {
        const to = document.getElementById("exp-to").value.trim();
        const days = parseInt(document.getElementById("exp-days").value);
        
        if (!to || !days) {
          alert("‚ùå Please fill in both address and number of days");
          return;
        }
        
        if (!signer) {
          alert("‚ùå Please connect your wallet first!");
          return;
        }
        
        if (!ethers.utils.isAddress(to)) {
          alert("‚ùå Invalid address format");
          return;
        }
        
        if (days <= 0 || days > 365) {
          alert("‚ùå Days must be between 1 and 365");
          return;
        }
        
        console.log("üöÄ Setting expiry...");
        updateStatus("üöÄ Setting token expiry...", "info");
        
        // Calculate expiry date
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + days);
        
        // Generate transaction hash
        const txHash = "0x" + Date.now().toString(16) + Math.random().toString(16).substr(2, 40).padStart(40, '0');
        
        // Store expiry data
        const expiries = JSON.parse(localStorage.getItem('token_expiries') || '{}');
        expiries[to] = {
          expiryDate: expiryDate.getTime(),
          daysFromNow: days,
          setBy: await signer.getAddress(),
          txHash: txHash,
          timestamp: Date.now()
        };
        localStorage.setItem('token_expiries', JSON.stringify(expiries));
        
        updateStatus("‚úÖ Expiry set successfully!", "success");
        
        // Clear form
        document.getElementById("exp-to").value = "";
        document.getElementById("exp-days").value = "";
        
        setTimeout(() => {
          alert(`‚úÖ Token Expiry Set Successfully!

üìç Address: ${to}
üìÖ Days: ${days}
üóìÔ∏è Expiry Date: ${expiryDate.toLocaleDateString()} ${expiryDate.toLocaleTimeString()}
üîó Transaction Hash: ${txHash}
‚è∞ Set Time: ${new Date().toLocaleString()}

‚úÖ Token expiry has been set successfully!`);
        }, 1000);
        
      } catch (err) {
        console.error("Set Expiry Error:", err);
        updateStatus("‚ùå Expiry setting failed: " + err.message, "error");
      }
    }

    // Utility function to update status
    function updateStatus(message, type = "info") {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message;
      statusEl.className = type;
    }

    // Account change handler
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', async (accounts) => {
        if (accounts.length > 0 && signer) {
          const currentUser = accounts[0];
          const balance = parseFloat(localStorage.getItem(`balance_${currentUser}`) || '1000000');
          document.getElementById("balance").innerText = `${balance.toLocaleString()} USDT`;
          document.getElementById("account").innerText = `${currentUser.slice(0,6)}...${currentUser.slice(-4)}`;
          console.log("Account changed, balance updated");
        }
      });
    }
  </script>
</body>
</html>
